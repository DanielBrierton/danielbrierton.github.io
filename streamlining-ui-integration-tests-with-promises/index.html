<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Streamlining UI Integration Tests with Promises - Daniel Brierton</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Writing integration tests for your UIs in JavaScript can get messy fast. You start off with some nice simple tests, and before you know it you’re in callback hell. By taking a step back and better str">
<meta property="og:type" content="article">
<meta property="og:title" content="Streamlining UI Integration Tests with Promises">
<meta property="og:url" content="https://daniel.brierton.me/streamlining-ui-integration-tests-with-promises/index.html">
<meta property="og:site_name" content="Daniel Brierton">
<meta property="og:description" content="Writing integration tests for your UIs in JavaScript can get messy fast. You start off with some nice simple tests, and before you know it you’re in callback hell. By taking a step back and better str">
<meta property="og:updated_time" content="2016-07-24T22:15:47.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Streamlining UI Integration Tests with Promises">
<meta name="twitter:description" content="Writing integration tests for your UIs in JavaScript can get messy fast. You start off with some nice simple tests, and before you know it you’re in callback hell. By taking a step back and better str">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="/webfonts/ptserif/main.css" rel='stylesheet' type='text/css'>
  <link href="/webfonts/source-code-pro/main.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-inner" class="inner">
      <a id="main-nav-toggle" class="nav-icon" href="javascript:;"></a>
      <a id="logo" class="logo logo-text" href="/">Daniel Brierton</a>
      <nav id="main-nav">
        
      </nav>
      <nav id="sub-nav">
        <div id="search-form-wrap">
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://daniel.brierton.me"></form>
        </div>
      </nav>
    </div>
  </div>
</header>
    <section id="main" class="outer"><article id="post-streamlining-ui-integration-tests-with-promises" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Streamlining UI Integration Tests with Promises
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/streamlining-ui-integration-tests-with-promises/" class="article-date">
  <time datetime="2015-10-28T00:00:00.000Z" itemprop="datePublished">2015-10-28</time>
</a>
      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>Writing integration tests for your UIs in JavaScript can get messy fast. You start off with some nice simple tests, and before you know it you’re in callback hell. By taking a step back and better structuring your tests and utilising the power of Promises though, you can avoid this. This post outlines how we tackled this problem and have made it quicker, easier, and cleaner to write integration tests in JavaScript.</p>
<a id="more"></a>
<p>For the purpose of this post, I’ll be using <a href="https://mochajs.org/" target="_blank" rel="external">Mocha</a> as my test runner, and you can assume waitForElement asynchronously waits for an element to be visible in the DOM. You should be easily able to adapt this to your favourite test runner. If you’re new to promises, I recommend you take a look at <a href="http://www.html5rocks.com/en/tutorials/es6/promises/" target="_blank" rel="external">Jake Archibalds primer on Promises on HTML5 Rocks</a>.</p>
<p>Let’s dive in. If you’ve ever written integration tests for some asynchronous JavaScript, you’ve probably written something like this.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">it(<span class="string">'Valid search should return results'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">done</span>) </span>&#123;</div><div class="line">    waitForElement(<span class="string">'#searchField'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">searchField</span>) </span>&#123;</div><div class="line">        searchField.value = <span class="string">'mySearch'</span>;</div><div class="line">        <span class="keyword">var</span> <span class="built_in">document</span>.getElementById(<span class="string">'searchButton'</span>);</div><div class="line">        searchButton.click();</div><div class="line">    </div><div class="line">        waitForElement(<span class="string">'#results'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">results</span>) </span>&#123;</div><div class="line">            <span class="comment">// ASSERTIONS</span></div><div class="line">            done();</div><div class="line">        &#125;);</div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>This is a simple example, but it could get worse as you write more complicated tests. As with most asynchronous code, we can improve the readability by using promises. With very little work, we can change our code to use promises.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">it(<span class="string">'Valid search should return results'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">done</span>) </span>&#123;</div><div class="line">    waitForElement(<span class="string">'#searchField'</span>)</div><div class="line">        .then(<span class="function"><span class="keyword">function</span> (<span class="params">searchField</span>) </span>&#123;</div><div class="line">            searchField.value = <span class="string">'mySearch'</span>;</div><div class="line">            <span class="keyword">var</span> <span class="built_in">document</span>.getElementById(<span class="string">'searchButton'</span>);</div><div class="line">            searchButton.click();</div><div class="line">            <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve();</div><div class="line">        &#125;)</div><div class="line">        .then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="keyword">return</span> waitForElement(<span class="string">'#results'</span>);</div><div class="line">        &#125;)</div><div class="line">        .then(<span class="function"><span class="keyword">function</span> (<span class="params">results</span>) </span>&#123;</div><div class="line">            <span class="comment">// ASSERTIONS</span></div><div class="line">        &#125;)</div><div class="line">        .then(done);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>Ok, it’s a little better. It gets past the nesting of callbacks, and each one does a specific function now, but it still looks a little messy. We’ll also end up rewriting most of this code over and over again.</p>
<p>For this, we want to simplify repeated actions. We can start by abstracting our view. This will give us more readable code, as well as making it easier to make small changes, whether it’s to IDs or class names. We can also create a few utility methods for common interactions.</p>
<h6 id="ViewModel"><a href="#ViewModel" class="headerlink" title="ViewModel"></a>ViewModel</h6><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> ViewModel = &#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Waits for the search field</div><div class="line">     * </div><div class="line">     * @method getSearchField</div><div class="line">     * @returns &#123;Promise&#125; promise</div><div class="line">     */</div><div class="line">    getSearchField: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> waitForElement(<span class="string">'#searchField'</span>);</div><div class="line">    &#125;,</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Waits for the search button</div><div class="line">     * </div><div class="line">     * @method getSearchButton</div><div class="line">     * @returns &#123;Promise&#125; promise</div><div class="line">     */</div><div class="line">    getSearchButton: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> waitForElement(<span class="string">'#searchButton'</span>);</div><div class="line">    &#125;,</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Waits for the results</div><div class="line">     * </div><div class="line">     * @method getResults</div><div class="line">     * @returns &#123;Promise&#125; promise</div><div class="line">     */</div><div class="line">    getResults: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> waitForElement(<span class="string">'#results'</span>);</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h6 id="CommonActions"><a href="#CommonActions" class="headerlink" title="CommonActions"></a>CommonActions</h6><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> CommonActions = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Returns a function to be used as a test step to set the value of the element from the previous test step.</div><div class="line">     *</div><div class="line">     * @method setValue</div><div class="line">     * @param &#123;String&#125; val</div><div class="line">     * @returns &#123;Function&#125; testStep</div><div class="line">     */</div><div class="line">    setValue: <span class="function"><span class="keyword">function</span> (<span class="params">val</span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">el</span>) </span>&#123;</div><div class="line">            el.value = val;</div><div class="line">            <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve();</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Clicks the provided element</div><div class="line">     * </div><div class="line">     * @method click</div><div class="line">     * @param &#123;HTMLElement&#125; el</div><div class="line">     * @returns &#123;Promise&#125; promise</div><div class="line">     */</div><div class="line">    click: <span class="function"><span class="keyword">function</span> (<span class="params">el</span>) </span>&#123;</div><div class="line">        el.click();</div><div class="line">        <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve();</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>Once we have this set up, we can further streamline our test.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">it(<span class="string">'Valid search should return results'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">done</span>) </span>&#123;</div><div class="line">    ViewModel.getSearchField()</div><div class="line">        .then(CommonActions.setValue(<span class="string">'mySearch'</span>))</div><div class="line">        .then(ViewModel.getSearchButton)</div><div class="line">        .then(CommonActions.click)</div><div class="line">        .then(ViewModel.getResults)</div><div class="line">        .then(<span class="function"><span class="keyword">function</span> (<span class="params">results</span>) </span>&#123;</div><div class="line">            <span class="comment">// ASSERTIONS</span></div><div class="line">            <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve();</div><div class="line">        &#125;)</div><div class="line">        .then(done);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>This is much more readable than our first test, as it basically reads as plain English. However, I wanted more flexibility, so I decided to take this further. I wrote a few functions to easier handle the lifecycle of the test. It might seem a little over the top at first, but bear with me. The comments explain what it does.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Ensure that the argument provided is usable in a chain of promises regardless of type.</div><div class="line"> * </div><div class="line"> * @method promisify</div><div class="line"> * @param &#123;*&#125; resp</div><div class="line"> * @returns &#123;Promise&#125; promise</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">promisify</span>(<span class="params">resp</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> resp &amp;&amp; resp.constructor === <span class="built_in">Promise</span> ? resp : <span class="built_in">Promise</span>.resolve(resp);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Check if argument is a function</div><div class="line"> *</div><div class="line"> * @method isFunction</div><div class="line"> * @param &#123;*&#125; functionToCheck</div><div class="line"> * @returns &#123;Boolean&#125; isFunction</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">isFunction</span>(<span class="params">functionToCheck</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> getType = &#123;&#125;;</div><div class="line">    <span class="keyword">return</span> functionToCheck &amp;&amp; getType.toString.call(functionToCheck) === <span class="string">'[object Function]'</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Runs a set of test steps passed in as an array.</div><div class="line"> *</div><div class="line"> * @method runTestSteps</div><div class="line"> * @param &#123;Array&#125; testSteps</div><div class="line"> * @return &#123;Promise&#125; lastPromise</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">runTestSteps</span>(<span class="params">testSteps</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> lastPromise = <span class="built_in">Promise</span>.resolve(); <span class="comment">// Just to chain off of</span></div><div class="line">    testSteps.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">testStep</span>) </span>&#123;</div><div class="line">        lastPromise.catch(<span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</div><div class="line">            <span class="comment">// Unfortunately need to do this to get a proper stack trace in mocha</span></div><div class="line">            requestAnimationFrame(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">                <span class="keyword">throw</span> e;</div><div class="line">            &#125;);</div><div class="line">        &#125;);</div><div class="line">        lastPromise = lastPromise.then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span> (isFunction(testStep)) &#123;</div><div class="line">                <span class="comment">// If testStep is a function, process as a normal promise</span></div><div class="line">                <span class="keyword">return</span> promisify(testStep.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>));</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (testStep &amp;&amp; testStep.constructor === <span class="built_in">Array</span>) &#123;</div><div class="line">                <span class="comment">// Recurse if it's an array</span></div><div class="line">                <span class="keyword">return</span> runTestSteps(testStep);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// Just resolve with the value of testStep isn't a function or array</span></div><div class="line">                <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(testStep);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">return</span> lastPromise;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Now that we’ve set up this boilerplate, we can define our tests with a simple array of test steps. We can also get rid of any “return Promise.resolve()”s we have, and can even call methods directly in our test steps that just return regular values. We can also bundle tests steps into functions for reuse.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the set of test steps to perform a search</div><div class="line"> *</div><div class="line"> * @method searchTestSteps</div><div class="line"> * @param &#123;String&#125; searchTerm</div><div class="line"> * @returns &#123;Array&#125; testSteps</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">searchTestSteps</span>(<span class="params">searchTerm</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> [</div><div class="line">        ViewModel.getSearchField,</div><div class="line">        CommonActions.setValue(searchTerm),</div><div class="line">        ViewModel.getSearchButton,</div><div class="line">        CommonActions.click</div><div class="line">    ];</div><div class="line">&#125;</div><div class="line"></div><div class="line">it(<span class="string">'Valid search should return results'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">done</span>) </span>&#123;</div><div class="line">    runTestSteps([</div><div class="line">        search(<span class="string">'validSearch'</span>),</div><div class="line">        ViewModel.getResults,</div><div class="line">        <span class="function"><span class="keyword">function</span> (<span class="params">results</span>) </span>&#123;</div><div class="line">            <span class="comment">// ASSERTIONS</span></div><div class="line">        &#125;,</div><div class="line">        done</div><div class="line">    ]);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>Now that we have everything nicely abstracted, we can very easily add another test for an invalid search.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">it(<span class="string">'Invalid search should return results'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">done</span>) </span>&#123;</div><div class="line">    runTestSteps([</div><div class="line">        search(<span class="string">'invalidSearch'</span>),</div><div class="line">        ViewModel.getResults,</div><div class="line">        <span class="function"><span class="keyword">function</span> (<span class="params">results</span>) </span>&#123;</div><div class="line">            <span class="comment">// ASSERTIONS</span></div><div class="line">        &#125;,</div><div class="line">        done</div><div class="line">    ]);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>And that’s about it. I hope this helps you write simpler, quicker UI integration tests. Any questions or feedback, sound off in the comments, or hit me up on Twitter <a href="https://twitter.com/DanielBrierton" target="_blank" rel="external">@DanielBrierton</a>.</p>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript-Testing-Promises/">JavaScript, Testing, Promises</a></li></ul>

      </footer>
    
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/my-google-io-2014-hopes-and-predictions/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">My Google I/O 2014 Hopes and Predictions&nbsp;<span>&gt;</span></div>
    </a>
  
</nav>

  
</article>

</section>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Daniel Brierton&nbsp;
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, theme by <a href="http://github.com/ppoffice">PPOffice</a>
    </div>
  </div>
</footer>
    

<script src="/js/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
  </div>
</body>
</html>